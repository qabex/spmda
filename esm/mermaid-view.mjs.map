{"version":3,"file":"mermaid-view.mjs","sources":["../code/tiny_loader.mjs","../code/view_utils.jsy","../code/mermaid-view.jsy"],"sourcesContent":["export default tiny_loader\nexport function tiny_loader(opt) {\n  const D = document\n  const src = 'string' === typeof opt ? opt : opt.src\n  if (src === opt) opt = {src: opt}\n  if (src != encodeURI(src))\n    throw new Error('Invalid script src')\n\n  let s = D.querySelector('script[src=\"'+ src + '\"]')\n  if (!s) {\n    s = D.createElement('script')\n\n    if (src.startsWith('http') && undefined === opt.crossorigin)\n      opt.crossorigin = 'anonymous'\n\n    D.head.appendChild(Object.assign(s, opt))\n  }\n\n  if (undefined === s.promise)\n    s.promise = new Promise((resolve, reject) => {\n      s.onload = e => resolve(e.target)\n      s.onerror = e => reject(e)\n    })\n\n  return s.promise\n}\n","\nexport const as_src_view = @!\n  const _cache = new Map()\n\n  const _as_view_class = baseElement => @\n    class SrcBaseElement extends baseElement ::\n      connectedCallback() ::\n        const src = this.textContent\n        this.textContent = ''\n        this._render_src(src, this.ownerDocument)\n\n      disconnectedCallback() ::\n\n      _render_src(src) ::\n        this.src = src\n\n      static initialize() ::\n        return this\n      static define_as(key) ::\n        const klass = this.initialize()\n        customElements.define @ key, klass\n        return klass\n\n  return @\\ baseElement ::\n    let res = _cache.get(baseElement)\n    if undefined === res ::\n      res = _as_view_class(baseElement)\n      _cache.set(baseElement, res)\n    return res\n\n\nexport function raf_batch(on_render) ::\n  let q=[], tid=null\n  return @\\ ...args ::\n    q.push(...args)\n    if null === tid ::\n      tid = requestAnimationFrame @ _batch\n\n  function _batch() ::\n    const batch = q\n    q=[]; tid=null\n    on_render(batch)\n\n\nexport const data_url = @\\ mime, src =>\n  `data:${mime},${encodeURIComponent(src)}`\nexport const svg_data_url = src =>\n  data_url @ 'image/svg+xml', src\n\n","import tiny_loader from './tiny_loader.mjs'\nimport {svg_data_url, as_src_view} from './view_utils.jsy'\n\nconst _mmd0 = @!>\n  await tiny_loader @ 'https://cdn.jsdelivr.net/npm/mermaid@8.4.5/dist/mermaidAPI.js'\n  const mermaid = window.mermaid\n  mermaid.initialize @: startOnLoad: false\n  return mermaid\n\n\nasync function _mermaid_svg_render(mermaid_src) ::\n  const mermaid = await _mmd0\n  let svg_xml\n  try ::\n    svg_xml = mermaid.render('root', mermaid_src)\n  catch err ::\n    console.warn @ 'Mermaid Rendering Problem:', err\n    return\n\n  // fixup SVG... but WHY?\n  svg_xml = svg_xml.replace @\n    'height=\"100%\"'\n    'preserveAspectRatio=\"xMinYMin meet\"'\n  return svg_xml\n\n\nexport class MermaidSVGView extends as_src_view(HTMLElement) ::\n  _render_svg(mermaid_src) :: return _mermaid_svg_render(mermaid_src)\n\n  async _render_src(mermaid_src, doc) ::\n    const svg_src = await this._render_svg(mermaid_src)\n    if ! svg_src :: return\n\n    const root = doc.createElement('figure')\n    root.innerHTML = svg_src\n    this.appendChild(root)\n\n\nexport class MermaidImgView extends as_src_view(HTMLElement) ::\n  _render_svg(mermaid_src) :: return _mermaid_svg_render(mermaid_src)\n\n  async _render_src(mermaid_src, doc) ::\n    const svg_src = await this._render_svg(mermaid_src)\n    if ! svg_src :: return\n\n    const root = doc.createElement('figure')\n    const img = doc.createElement('img')\n    img.src = svg_data_url(svg_src)\n    root.appendChild(img)\n    this.appendChild(root)\n\n\nMermaidImgView.define_as @ 'mermaid-img-view'\nMermaidSVGView.define_as @ 'mermaid-svg-view'\n\nexport class MermaidView extends MermaidImgView ::\nMermaidView.define_as @ 'mermaid-view'\n\nexport default MermaidView\n\n"],"names":[],"mappings":"AACO,SAAS,WAAW,CAAC,GAAG,EAAE;AACjC,EAAE,MAAM,CAAC,GAAG,SAAQ;AACpB,EAAE,MAAM,GAAG,GAAG,QAAQ,KAAK,OAAO,GAAG,GAAG,GAAG,GAAG,GAAG,CAAC,IAAG;AACrD,EAAE,IAAI,GAAG,KAAK,GAAG,EAAE,GAAG,GAAG,CAAC,GAAG,EAAE,GAAG,EAAC;AACnC,EAAE,IAAI,GAAG,IAAI,SAAS,CAAC,GAAG,CAAC;AAC3B,IAAI,MAAM,IAAI,KAAK,CAAC,oBAAoB,CAAC;AACzC;AACA,EAAE,IAAI,CAAC,GAAG,CAAC,CAAC,aAAa,CAAC,cAAc,EAAE,GAAG,GAAG,IAAI,EAAC;AACrD,EAAE,IAAI,CAAC,CAAC,EAAE;AACV,IAAI,CAAC,GAAG,CAAC,CAAC,aAAa,CAAC,QAAQ,EAAC;AACjC;AACA,IAAI,IAAI,GAAG,CAAC,UAAU,CAAC,MAAM,CAAC,IAAI,SAAS,KAAK,GAAG,CAAC,WAAW;AAC/D,MAAM,GAAG,CAAC,WAAW,GAAG,YAAW;AACnC;AACA,IAAI,CAAC,CAAC,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,EAAE,GAAG,CAAC,EAAC;AAC7C,GAAG;AACH;AACA,EAAE,IAAI,SAAS,KAAK,CAAC,CAAC,OAAO;AAC7B,IAAI,CAAC,CAAC,OAAO,GAAG,IAAI,OAAO,CAAC,CAAC,OAAO,EAAE,MAAM,KAAK;AACjD,MAAM,CAAC,CAAC,MAAM,GAAG,CAAC,IAAI,OAAO,CAAC,CAAC,CAAC,MAAM,EAAC;AACvC,MAAM,CAAC,CAAC,OAAO,GAAG,CAAC,IAAI,MAAM,CAAC,CAAC,EAAC;AAChC,KAAK,EAAC;AACN;AACA,EAAE,OAAO,CAAC,CAAC,OAAO;AAClB;;;ECvBE;;EAEA;IACE;MACE;QACE;QACA,mBAAmB;QACnB;;MAEF;;MAEA;QACE;;MAEF;QACE;MACF;QACE;QACA,sBAAuB;QACvB;;EAEN;IACE;QACE;MACA;MACA;IACF;;;;EAiBF,QAAQ,KAAK,GAAG,wBAAwB;;EAExC,SAAU,eAAgB;;AC5C5B;EACE,kBAAmB;EACnB;EACA,oBAAqB;EACrB;;;AAGF;EACE;EACA;EACA;IACE,yBAAyB,MAAM;SAC5B;IACH,aAAc,4BAA6B;IAC3C;;;EAGF;IACE;IACA;EACF;;;;EAIA,0BAA2B;;EAE3B;IACE;QACG,YAAY;;IAEf,+BAA+B,QAAQ;IACvC;IACA;;;;EAIF,0BAA2B;;EAE3B;IACE;QACG,YAAY;;IAEf,+BAA+B,QAAQ;IACvC,8BAA8B,KAAK;IACnC;IACA;IACA;;;AAGJ,yBAA0B;AAC1B,yBAA0B;;;AAG1B,sBAAuB;;;;;"}
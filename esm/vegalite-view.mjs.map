{"version":3,"file":"vegalite-view.mjs","sources":["../code/tiny_loader.mjs","../code/view_utils.jsy","../code/deps.jsy","../code/vegalite-view.jsy"],"sourcesContent":["export default tiny_loader\nexport function tiny_loader(opt) {\n  const D = document\n  const src = 'string' === typeof opt ? opt : opt.src\n  if (src === opt) opt = {src: opt}\n  if (src != encodeURI(src))\n    throw new Error('Invalid script src')\n\n  let s = D.querySelector('script[src=\"'+ src + '\"]')\n  if (!s) {\n    s = D.createElement('script')\n\n    if (src.startsWith('http') && undefined === opt.crossorigin)\n      opt.crossorigin = 'anonymous'\n\n    D.head.appendChild(Object.assign(s, opt))\n  }\n  \n  if (undefined === s.promise)\n    s.promise = new Promise((resolve, reject) => {\n      s.onload = e => resolve(e.target)\n      s.onerror = e => reject(e)\n    })\n\n  return s.promise\n}\n","\nexport const as_src_view = @!\n  const _cache = new Map()\n\n  const _as_view_class = baseElement => @\n    class SrcBaseElement extends baseElement ::\n      connectedCallback() ::\n        const src = this.textContent\n        this.textContent = ''\n        this._render_src(src, this.ownerDocument)\n\n      _render_src(src) ::\n        this.src = src\n\n      static initialize() ::\n        return this\n      static define_as(key) ::\n        const klass = this.initialize()\n        customElements.define @ key, klass\n        return klass\n\n  return @\\ baseElement ::\n    let res = _cache.get(baseElement)\n    if undefined === res ::\n      res = _as_view_class(baseElement)\n      _cache.set(baseElement, res)\n    return res\n\n\nexport function raf_batch(on_render) ::\n  let q=[], tid=null\n  return @\\ ...args ::\n    q.push(...args)\n    if null === tid ::\n      tid = requestAnimationFrame @ _batch\n\n  function _batch() ::\n    const batch = q\n    q=[]; tid=null\n    on_render(batch)\n\n\nexport function fetch_cors_get(src, headers) ::\n  return fetch @ src, @{} method: 'GET', mode: 'cors', headers\nexport async function fetch_json(src, headers) ::\n  const req = await fetch_cors_get(src, headers)\n  return req.json()\nexport async function fetch_text(src, headers) ::\n  const req = await fetch_cors_get(src, headers)\n  return req.text()\n\nexport const data_url = @\\ mime, src =>\n  `data:${mime},${encodeURIComponent(src)}`\nexport const svg_data_url = src =>\n  data_url @ 'image/svg+xml', src\n\n","export {default as JSON5} from 'https://cdn.jsdelivr.net/npm/json5@2.1.1/dist/index.min.mjs'\n\nexport function json5_human(json_src) ::\n  json_src = json_src.trim()\n  if '{' !== json_src[0] ::\n    json_src = `{${json_src}}`\n  return JSON5.parse @ json_src\n\n","import tiny_loader from './tiny_loader.mjs'\nimport {as_src_view} from './view_utils.jsy'\nimport {json5_human} from './deps.jsy'\n\nclass VegaLiteViewBaseElement extends as_src_view(HTMLElement) ::\n  connectedCallback() ::\n    super.connectedCallback()\n    this.dispatchEvent @ new CustomEvent @ 'start'\n\n  disconnectedCallback() ::\n    super.disconnectedCallback()\n    this.dispatchEvent @ new CustomEvent @ 'finish'\n\n  get hover() :: return this.hasAttribute @ 'hover'\n  set hover(v) ::\n    if v :: this.setAttribute @ 'hover', ''\n    else this.removeAttribute @ 'hover'\n\n\n  async _render_src(vegalite_src) ::\n    let vl_doc = this.parseDoc @ vegalite_src\n    return this.renderDoc @ vl_doc\n\n  parseDoc(vegalite_src) ::\n    try :: return json5_human @ vegalite_src\n    catch err ::\n      console.warn @ 'VegaLite parsing problem:', err\n\n  async renderDoc(vegalite_doc) ::\n    if 'string' === typeof vegalite_doc ::\n      vegalite_doc = this.parseDoc(vegalite_doc)\n\n    const {vega, vegaLite} = await this._vegalite\n\n    const vega_spec = this.vega_spec =\n      vegaLite.compile @ vegalite_doc\n\n    const container = this._container @\n      this.ownerDocument\n    const {renderer, hover}=this\n    const vega_view = this.vega_view =\n      new vega.View @\n        vega.parse(vega_spec.spec)\n        @{} renderer, hover, container\n\n    //this.appendChild(container)\n    vega_view.runAsync()\n\n  _container(doc) :: return this\n\n  static initialize() ::\n    this._vegalite = this.prototype._vegalite =\n      this._init_vegalite()\n    return this\n\n  static async _init_vegalite() ::\n    ::\n      const deps = @[]\n        tiny_loader @ 'https://cdn.jsdelivr.net/npm/vega@5.10.0'\n        tiny_loader @ 'https://cdn.jsdelivr.net/npm/vega-lite@4.7.0'\n\n      while deps.length :: await deps.pop()\n\n    const {vega, vegaLite} = window\n    return {vega, vegaLite}\n\n\nVegaLiteViewBaseElement.prototype._data = @{}\n  $schema: 'https://vega.github.io/schema/vega-lite/v4.json'\n  mark: 'point'\n\n\nclass VegaLiteViewElement extends VegaLiteViewBaseElement ::\n  get renderer() :: return this.getAttribute @ 'renderer'\n  set renderer(v) :: this.setAttribute @ 'renderer', v\n\nclass VegaLiteSVGViewElement extends VegaLiteViewBaseElement ::\n  get renderer() :: return 'svg'\n\nclass VegaLiteCanvasViewElement extends VegaLiteViewBaseElement ::\n  get renderer() :: return 'canvas'\n\nVegaLiteViewElement.define_as @ 'vegalite-view'\nVegaLiteSVGViewElement.define_as @ 'vegalite-svg-view'\nVegaLiteCanvasViewElement.define_as @ 'vegalite-canvas-view'\n\n"],"names":[],"mappings":";;;EAEE;EACA,YAAY,QAAQ;EACpB;EACA;IACE,gBAAgB,oBAAoB;;EAEtC,wBAAwB,cAAc,QAAQ,IAAI;EAClD;IACE,oBAAoB,QAAQ;;IAE5B,mBAAmB,MAAM;MACvB,kBAAkB;;IAEpB;;;EAGF;IACE;MACE;MACA;;;EAGJ;AACF;;;ECvBE;;EAEA;IACE;MACE;QACE;QACA,mBAAmB;QACnB;;MAEF;QACE;;MAEF;QACE;MACF;QACE;QACA,sBAAuB;QACvB;;EAEN;IACE;QACE;MACA;MACA;IACF;;;ECvBF;MACG,GAAG;IACJ,WAAW,IAAI,SAAS;EAC1B,mBAAoB;;ACFtB;EACE;IACE;IACA,mBAAoB,gBAAkB;;EAExC;IACE;IACA,mBAAoB,gBAAkB;;EAExC,aAAc,yBAA2B;EACzC;QACI,IAAK,kBAAoB,OAAQ,EAAE;8BACV;;;EAG7B;IACE,2BAA4B;IAC5B,sBAAuB;;EAEzB;IACE,KAAM,mBAAqB;WACtB;MACH,aAAc,2BAA4B;;EAE9C;QACK,QAAQ;MACT;;IAEF;;IAEA;MACE,iBAAkB;;IAEpB;MACE;IACF;IACA;MACE;QACE;SACG;;;IAGP;;EAEF,iBAAkB;;EAElB;IACE;MACE;IACF;;EAEF;;MAEI;QACE,YAAa;QACb,YAAa;;aAEV,cAAe;;IAEtB;IACA;;;AAGJ;EACE,SAAS;EACT,MAAM;;;AAGR;EACE,gBAAiB,yBAA2B;EAC5C,iBAAkB,kBAAoB,UAAW;;AAEnD;EACE,gBAAiB,OAAQ;;AAE3B;EACE,gBAAiB,OAAQ;;AAE3B,8BAA+B;AAC/B,iCAAkC;AAClC,oCAAqC"}